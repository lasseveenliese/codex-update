#!/bin/zsh
set -euo pipefail

# ------------------------------------------------------------
# codex-update
# - compares installed codex version with npm latest
# - asks before updating (y/n)
# - updates directly with -y
# ------------------------------------------------------------

usage() {
  cat <<'EOF'
Usage: codex-update [-y]

Options:
  -y            Install update without confirmation
  -h, --help    Show help
EOF
}

auto_yes=0
case "${1:-}" in
  -y) auto_yes=1 ;;
  -h|--help)
    usage
    exit 0
    ;;
  "" ) ;;
  * )
    echo "Unknown argument: $1" >&2
    usage >&2
    exit 2
    ;;
esac

die() {
  echo "Error: $1" >&2
  exit 2
}

need_cmd() {
  command -v "$1" >/dev/null 2>&1 || die "$1 not found"
}

get_semver() {
  # Extracts the first x.y.z from a string.
  # Example: "codex 0.99.0" -> "0.99.0"
  echo "$1" | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+' | head -n1
}

do_update() {
  echo "Installing update: npm i -g @openai/codex"
  npm i -g @openai/codex
  echo "New version: $(codex --version)"
}

need_cmd codex
need_cmd npm
need_cmd grep
need_cmd head
need_cmd tr

installed_raw="$(codex --version)"
latest_raw="$(npm view @openai/codex version)"

installed="$(get_semver "$installed_raw")"
latest="$(echo "$latest_raw" | tr -d '[:space:]')"

[[ -n "$installed" ]] || die "Could not parse installed version: $installed_raw"
[[ -n "$latest" ]] || die "Could not determine latest version"

echo "installed: $installed"
echo "latest:    $latest"

autoload -Uz is-at-least

# is-at-least MIN CURRENT -> true when CURRENT >= MIN
if is-at-least "$latest" "$installed"; then
  echo "Up to date."
  exit 0
fi

echo "Update available."

if [[ "$auto_yes" -eq 1 ]]; then
  do_update
  exit 0
fi

[[ -t 0 ]] || die "No interactive terminal. Use -y for automatic update."

printf "Install update? (y/n) "
read -r ans
case "${ans:l}" in
  y|yes) do_update ;;
  n|no)
    echo "Canceled."
    exit 1
    ;;
  *)
    echo "Please answer y or n."
    exit 1
    ;;
esac
